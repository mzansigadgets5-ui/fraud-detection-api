from fastapi import FastAPI, UploadFile, File, Depends, Security, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.security import APIKeyHeader, APIKeyQuery
import os
import uvicorn

from advanced_fraud import analyze_pdf_advanced
from swagger_fix import patch_openapi

# ------------------ API KEY SETUP ------------------

API_KEY = "test-123"

api_key_query = APIKeyQuery(name="api_key", auto_error=False)
api_key_header = APIKeyHeader(name="x-api-key", auto_error=False)

def verify_api_key(q: str = Security(api_key_query), h: str = Security(api_key_header)):
    return q == API_KEY or h == API_KEY

# ------------------ FASTAPI APP ------------------

app = FastAPI(title="ELITE Fraud Engine")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"]
)

app.openapi = lambda: patch_openapi(app)

# ------------------ HEALTH CHECK ------------------

@app.get("/health")
def health():
    return {"status": "online"}

# ------------------ FRAUD ANALYSIS ENDPOINT ------------------

@app.post("/analyze-statement")
async def analyze_statement(
    file: UploadFile = File(...),
    api_key: str = Depends(verify_api_key)
):
    if not api_key:
        return {"error": "Invalid or missing API key"}

    # Ensure uploads folder exists
    os.makedirs("uploads", exist_ok=True)

    # Save the file
    file_location = f"uploads/{file.filename}"
    with open(file_location, "wb") as f:
        f.write(await file.read())

    # Run Advanced Fraud Engine
    fraud_result = analyze_pdf_advanced(file_location)
    return fraud_result

# ------------------ RUN SERVER ------------------

if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=9000)
